
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì´ë¯¸ì§€ ìƒì„±ê¸° (ë¸”ë¡œê·¸ ì‚¬ì§„ ì±„ìš°ê¸°)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ ì„¤ì • -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* ë¼ì´íŠ¸ ê·¸ë ˆì´ ë°°ê²½ */
        }
        .skeleton {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 md:p-10 border border-gray-100">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">
            ğŸ–¼ï¸ ë¸”ë¡œê·¸ ì‚¬ì§„ ì±„ìš°ê¸° AI ì´ë¯¸ì§€ ìƒì„±ê¸°
        </h1>
        <p class="text-gray-600 mb-6">
            ë¸”ë¡œê·¸ì— ì‚¬ìš©í•  ë©‹ì§„ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”. ì‚¬ì§„ì— ëŒ€í•œ ì„¤ëª…ì„ í•œêµ­ì–´ë‚˜ ì˜ì–´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.
        </p>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="space-y-4 mb-8">
            <textarea
                id="promptInput"
                placeholder="ì˜ˆ: ë”°ëœ»í•œ í–‡ì‚´ ì•„ë˜ ë°”ë‹¤ê°€ ë³´ì´ëŠ” ì•„ëŠ‘í•œ ì¹´í˜ì—ì„œ ì»¤í”¼ë¥¼ ë§ˆì‹œëŠ” ëª¨ìŠµ (ê³ í™”ì§ˆ, í•„ë¦„ ì‚¬ì§„ ìŠ¤íƒ€ì¼)"
                rows="3"
                class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 resize-none shadow-sm"
            ></textarea>

            <button
                id="generateButton"
                class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-200 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="generateImage()"
            >
                ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°
            </button>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div id="resultContainer">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ìƒì„±ëœ ì´ë¯¸ì§€</h2>

            <!-- ì´ë¯¸ì§€ ë° ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="imageDisplay" class="min-h-72 flex items-center justify-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl overflow-hidden">
                <p id="initialMessage" class="text-gray-500 p-4 text-center">
                    ì„¤ëª…ì„ ì…ë ¥í•˜ê³  'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!
                </p>
                <!-- ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
                <div id="loadingSkeleton" class="p-4 w-full h-full hidden">
                    <div class="skeleton bg-gray-300 rounded-xl w-full h-72 mb-4"></div>
                    <div class="skeleton bg-gray-300 rounded-lg w-3/4 h-5 mx-auto"></div>
                </div>
                <!-- ì—ëŸ¬ ë©”ì‹œì§€ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
                <div id="errorMessage" class="hidden text-center text-red-600 p-4">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <p>ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
                    <p id="errorDetail" class="text-sm mt-1"></p>
                </div>
                <!-- ìƒì„±ëœ ì´ë¯¸ì§€ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
                <img id="generatedImage" class="w-full h-auto max-h-[500px] object-contain hidden" alt="ìƒì„±ëœ ì´ë¯¸ì§€">
            </div>

            <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
            <div class="mt-4 text-center">
                <button
                    id="downloadButton"
                    class="hidden px-4 py-2 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition duration-200 ease-in-out shadow-md"
                    onclick="downloadImage()"
                >
                    ë‹¤ìš´ë¡œë“œ (PNG)
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firestore ë° Auth í™˜ê²½ ë³€ìˆ˜ (ì‚¬ìš©ë˜ì§€ ì•ŠìŒ, ì´ë¯¸ì§€ ìƒì„±ì€ ì™¸ë¶€ API í˜¸ì¶œ)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const promptInput = document.getElementById('promptInput');
        const generateButton = document.getElementById('generateButton');
        const initialMessage = document.getElementById('initialMessage');
        const imageDisplay = document.getElementById('imageDisplay');
        const loadingSkeleton = document.getElementById('loadingSkeleton');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetail = document.getElementById('errorDetail');
        const generatedImage = document.getElementById('generatedImage');
        const downloadButton = document.getElementById('downloadButton');

        // ì´ë¯¸ì§€ ìƒì„± API ê´€ë ¨ ì„¤ì •
        // **ì£¼ì˜: ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ë•ŒëŠ” 'imagen-4.0-generate-001' ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.**
        const API_KEY = ""; // ëŸ°íƒ€ì„ì— ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`;
        
        let currentImageUrl = null; // ìƒì„±ëœ ì´ë¯¸ì§€ì˜ Base64 URL ì €ì¥

        /**
         * ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ì„ APIì— ì „ì†¡í•˜ê³  ê²°ê³¼ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        async function generateImage() {
            const prompt = promptInput.value.trim();

            if (!prompt) {
                alertUser('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            // UI ìƒíƒœ ì´ˆê¸°í™” ë° ë¡œë”© ì‹œì‘
            resetUI();
            generateButton.disabled = true;
            loadingSkeleton.classList.remove('hidden');
            initialMessage.classList.add('hidden');
            imageDisplay.classList.remove('border-dashed', 'border-gray-300');


            // API ìš”ì²­ í˜ì´ë¡œë“œ
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: {
                    sampleCount: 1, // ìƒì„±í•  ì´ë¯¸ì§€ ê°œìˆ˜
                    // ì´ë¯¸ì§€ í’ˆì§ˆ ë° í¬ê¸° ì„¤ì • (ë¸”ë¡œê·¸ì— ì í•©í•˜ê²Œ 1:1 ë¹„ìœ¨ ì„ íƒ)
                    aspectRatio: "1:1",
                    outputMimeType: "image/png"
                }
            };

            // ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ìœ„í•œ ì„¤ì •
            const MAX_RETRIES = 5;
            let currentRetry = 0;

            while (currentRetry < MAX_RETRIES) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API ìš”ì²­ ì‹¤íŒ¨: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                    if (!base64Data) {
                        throw new Error("ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì‘ë‹µì— í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    }

                    // Base64 ë°ì´í„°ë¥¼ ì´ë¯¸ì§€ URLë¡œ ë³€í™˜
                    currentImageUrl = `data:image/png;base64,${base64Data}`;
                    generatedImage.src = currentImageUrl;

                    // UI ì—…ë°ì´íŠ¸
                    loadingSkeleton.classList.add('hidden');
                    generatedImage.classList.remove('hidden');
                    downloadButton.classList.remove('hidden');
                    imageDisplay.classList.add('p-0'); // ì´ë¯¸ì§€ ì±„ìš°ê¸°ë¥¼ ìœ„í•´ íŒ¨ë”© ì œê±°

                    break; // ì„±ê³µ ì‹œ ë£¨í”„ ì¢…ë£Œ

                } catch (error) {
                    console.error("ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:", error.message);
                    currentRetry++;

                    if (currentRetry < MAX_RETRIES) {
                        // ì§€ìˆ˜ ë°±ì˜¤í”„: 1ì´ˆ, 2ì´ˆ, 4ì´ˆ ... ëŒ€ê¸°
                        const delay = Math.pow(2, currentRetry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        // console.log(`ì¬ì‹œë„ (${currentRetry}/${MAX_RETRIES}). ${delay / 1000}ì´ˆ ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.`);
                    } else {
                        // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
                        handleError(error.message);
                        break;
                    }
                }
            }
            
            generateButton.disabled = false;
        }

        /**
         * UI ìƒíƒœë¥¼ ì´ˆê¸° ë©”ì‹œì§€ ìƒíƒœë¡œ ì¬ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function resetUI() {
            generatedImage.classList.add('hidden');
            loadingSkeleton.classList.add('hidden');
            errorMessage.classList.add('hidden');
            downloadButton.classList.add('hidden');
            imageDisplay.classList.add('border-dashed', 'border-gray-300');
            imageDisplay.classList.remove('p-0');
            initialMessage.classList.add('hidden');
            errorDetail.textContent = '';
            currentImageUrl = null;
        }

        /**
         * ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  UI ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {string} message - í‘œì‹œí•  ì—ëŸ¬ ë©”ì‹œì§€
         */
        function handleError(message) {
            loadingSkeleton.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorDetail.textContent = `(${message.substring(0, 100)}...)`;
            imageDisplay.classList.add('border-dashed', 'border-gray-300');
            imageDisplay.classList.remove('p-0');
            generatedImage.classList.add('hidden');
            initialMessage.classList.add('hidden');
        }

        /**
         * ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ (ê²½ê³  ë“±)ë¥¼ í‘œì‹œí•˜ëŠ” ì»¤ìŠ¤í…€ ëª¨ë‹¬ í•¨ìˆ˜ì…ë‹ˆë‹¤.
         * window.alert() ì‚¬ìš© ê¸ˆì§€ ê·œì •ì— ë”°ë¼ ì»¤ìŠ¤í…€ UIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
         * @param {string} message - ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ë©”ì‹œì§€
         * @param {string} type - ë©”ì‹œì§€ ìœ í˜• ('warning', 'info' ë“±)
         */
        function alertUser(message, type) {
            // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” ëª¨ë‹¬ UIë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
            
            // ë³€ê²½: console.error ëŒ€ì‹  console.warnì„ ì‚¬ìš©í•˜ì—¬ ì‹¬ê°í•œ ì˜¤ë¥˜ì™€ êµ¬ë¶„
            if (type === 'warning') {
                console.warn(`[ì‚¬ìš©ì ì•Œë¦¼ - WARNING]: ${message}`);
            } else {
                console.info(`[ì‚¬ìš©ì ì•Œë¦¼ - INFO]: ${message}`);
            }

            // ì‚¬ìš©ìì—ê²Œ ë³´ì¼ ìˆ˜ ìˆëŠ” ì„ì‹œ ë©”ì‹œì§€ í‘œì‹œ
            let tempMessage = document.getElementById('tempAlertMessage');
            if (tempMessage) {
                tempMessage.remove(); // ì´ì „ ë©”ì‹œì§€ ì œê±°
            }

            tempMessage = document.createElement('p');
            tempMessage.id = 'tempAlertMessage';
            tempMessage.textContent = message;

            // ë©”ì‹œì§€ ìœ í˜•ì— ë”°ë¥¸ ë°°ê²½ìƒ‰ ì„¤ì •
            const bgColor = type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';

            tempMessage.className = `fixed top-0 left-1/2 -translate-x-1/2 max-w-sm w-full ${bgColor} text-white p-3 text-center rounded-b-lg shadow-xl z-50 transition-all duration-300 transform opacity-0 scale-95`;
            
            document.body.appendChild(tempMessage);

            // ì• ë‹ˆë©”ì´ì…˜ì„ í†µí•´ ë©”ì‹œì§€ í‘œì‹œ
            setTimeout(() => {
                tempMessage.style.opacity = '1';
                tempMessage.style.transform = 'translate(-50%, 0) scale(1)';
            }, 10);

            // 3ì´ˆ í›„ ì• ë‹ˆë©”ì´ì…˜ì„ í†µí•´ ë©”ì‹œì§€ ì œê±°
            setTimeout(() => {
                tempMessage.style.opacity = '0';
                tempMessage.style.transform = 'translate(-50%, -100%) scale(0.95)';
                setTimeout(() => {
                    tempMessage.remove();
                }, 300); // ì „í™˜ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
            }, 3000);
        }
        
        /**
         * ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
         */
        function downloadImage() {
            if (currentImageUrl) {
                const link = document.createElement('a');
                link.href = currentImageUrl;
                // íŒŒì¼ ì´ë¦„ì„ í”„ë¡¬í”„íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •í•˜ê±°ë‚˜ ê¸°ë³¸ ì´ë¦„ ì‚¬ìš©
                const promptPreview = promptInput.value.trim().substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_') || 'ai_generated_image';
                link.download = `${promptPreview}_${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alertUser('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
            }
        }
    </script>
</body>
</html>
